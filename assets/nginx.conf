
#user http;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    client_max_body_size 81920m;

    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;
    ssl_certificate     /home/yunyuyuan/.acme.sh/*.yunyuyuan.net/fullchain.cer;
    ssl_certificate_key /home/yunyuyuan/.acme.sh/*.yunyuyuan.net/*.yunyuyuan.net.key;

    #gzip  on;
    server {
        listen [::]:8888 ssl;
        server_name _;
        error_page 497 https://$host:8888$request_uri;

        location / {
                proxy_pass https://localhost:443;
                proxy_set_header Host $host;
        }
    }
    # for cloudflared tunnel
    server {
        listen 127.0.0.1:8889;
        server_name _;

        location / {
                proxy_pass https://localhost:443;
                proxy_set_header Host $host;
        }
    }
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }


    server {
        listen 443 ssl;
        server_name i-cf.yunyuyuan.net i-d.yunyuyuan.net i-v.yunyuyuan.net i-ts.yunyuyuan.net;

        root /var/www/i;
    }

    server {
        listen 443 ssl;
        server_name ttyd-d.yunyuyuan.net ttyd-v.yunyuyuan.net ttyd-ts.yunyuyuan.net;

        location / {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://127.0.0.1:7896;
        }
    }

    server {
        listen 443 ssl;
        server_name novnc-d.yunyuyuan.net novnc-v.yunyuyuan.net novnc-ts.yunyuyuan.net;

        location = / {
                return 302 /vnc.html;
        }

        location / {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://127.0.0.1:6081;
        }
    }

    server {
        listen 443 ssl;
        server_name aria-cf.yunyuyuan.net aria-d.yunyuyuan.net aria-v.yunyuyuan.net aria-ts.yunyuyuan.net;

        root /var/www/aria;
        location /jsonrpc {
                proxy_pass http://localhost:6800/jsonrpc;
                proxy_redirect off;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $host;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }
    }

    server {
        listen 443 ssl;
        server_name fb-d.yunyuyuan.net fb-v.yunyuyuan.net fb-ts.yunyuyuan.net;

        location / {
                proxy_pass http://127.0.0.1:5886;
        }
    }
    server {
        listen 443 ssl;
        server_name file-d.yunyuyuan.net file-v.yunyuyuan.net file-ts.yunyuyuan.net;

        location = /.well-known/carddav {
                return 301 $scheme://$host:$server_port/remote.php/dav;
        }
        location = /.well-known/caldav {
                return 301 $scheme://$host:$server_port/remote.php/dav;
        }

        location / {
                proxy_redirect off;
                proxy_pass http://127.0.0.1:5885;
                proxy_set_header Host $http_host;
                proxy_hide_header Content-Security-Policy;
        }
    }
    server {
        listen 443 ssl;
        server_name download-d.yunyuyuan.net download-v.yunyuyuan.net download-ts.yunyuyuan.net;

        location / {
            proxy_pass http://127.0.0.1:9090;
            proxy_redirect off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
            proxy_set_header X-NginX-Proxy true;
        }
    }
    server {
        listen 443 ssl;
        server_name video-cf.yunyuyuan.net video-d.yunyuyuan.net video-v.yunyuyuan.net video-ts.yunyuyuan.net;

        set $jellyfin 127.0.0.1;
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        set $dist_url "/web/";

        if ($host ~ ^video-d) {
            set $dist_url ":8888/web/";
        }

        location = / {
            return 302 https://$host$dist_url;
        }
        location = /web {
            return 302 https://$host$dist_url;
        }
    
        location / {
            proxy_pass http://$jellyfin:8096;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
    
            proxy_buffering off;
        }
        location = /web/ {
            proxy_pass http://$jellyfin:8096/web/index.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
        }
        location /socket {
            # Proxy Jellyfin Websockets traffic
            proxy_pass http://$jellyfin:8096;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
        }
    }

    server {
        listen 443 ssl;
        server_name status-cf.yunyuyuan.net status-d.yunyuyuan.net status-v.yunyuyuan.net status-ts.yunyuyuan.net;

        auth_basic  "Restricted";
        auth_basic_user_file  /etc/nginx/auth-pairs;

        location / {
                proxy_pass http://127.0.0.1:9889;
        }
    }

    server {
        listen 443 ssl;
        server_name speed-cf.yunyuyuan.net speed-d.yunyuyuan.net speed-v.yunyuyuan.net speed-ts.yunyuyuan.net;

        auth_basic  "Restricted";
        auth_basic_user_file  /etc/nginx/auth-pairs;

        location / {
                proxy_pass http://127.0.0.1:8111;
        }
    }

    server {
        listen 443 ssl;
        server_name git-d.yunyuyuan.net git-v.yunyuyuan.net git-ts.yunyuyuan.net;

        location / {
                proxy_pass http://127.0.0.1:7654;
                proxy_set_header Host git.yunyuyuan.net;
        }
    }

    server {
        listen 443 ssl;
        server_name code-server-d.yunyuyuan.net code-server-v.yunyuyuan.net code-server-ts.yunyuyuan.net;

        location / {
                proxy_pass http://127.0.0.1:8121;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Protocol $scheme;
                proxy_set_header X-Forwarded-Host $http_host;
        }
    }

    server {
        listen 443 ssl;
        server_name money-d.yunyuyuan.net money-cf.yunyuyuan.net money-v.yunyuyuan.net money-ts.yunyuyuan.net;

        location / {
                proxy_pass http://127.0.0.1:8686;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto "https";
                proxy_set_header X-Forwarded-Protocol "https";
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_hide_header Content-Security-Policy;
        }
    }
}
